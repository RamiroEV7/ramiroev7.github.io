name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Configure Next.js for GitHub Pages
      run: |
        # Reemplazar el nombre del repositorio en el archivo de configuración
        REPO_NAME="${{ github.repository }}"
        REPO_NAME="${REPO_NAME#*/}"
        sed -i "s|basePath: '/nombre-de-tu-repo'|basePath: '/${REPO_NAME}'|g" next.config.ts
        sed -i "s|assetPrefix: '/nombre-de-tu-repo'|assetPrefix: '/${REPO_NAME}'|g" next.config.ts
        
    - name: Build and export
      run: npm run export
      
    - name: Create docs directory
      run: mkdir -p docs
      
    - name: Copy built files to docs
      run: cp -r out/* docs/
      
    - name: Add custom 404 page
      run: |
        # Crear página 404 que redirige al index
        cat > docs/404.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>Redirigiendo...</title>
          <script>
            var path = window.location.pathname.split('/');
            var repo = path[1];
            window.location.replace('/' + repo + '/');
          </script>
        </head>
        <body>
          <p>Redirigiendo a la página principal...</p>
        </body>
        </html>
        EOF
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/
        git add next.config.ts
        git commit -m "Deploy to GitHub Pages" || exit 0
        git push